{{- if .Values.postgres.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "inmidst.name" . }}-pg-backup
  labels:
    {{- include "inmidst.labels" . | nindent 4 }}
    app.kubernetes.io/component: backup
spec:
  schedule: {{ .Values.backup.schedule | default "0 3 * * *" | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      activeDeadlineSeconds: 3600
      template:
        metadata:
          labels:
            app: {{ include "inmidst.name" . }}-pg-backup
            app.kubernetes.io/component: backup
        spec:
          restartPolicy: OnFailure
          containers:
            - name: pg-backup
              image: {{ .Values.postgres.image }}
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                  BACKUP_FILE="/backups/midst-${TIMESTAMP}.sql.gz"

                  echo "Starting backup at ${TIMESTAMP}..."
                  PGPASSWORD="${POSTGRES_PASSWORD}" pg_dump \
                    -h {{ include "inmidst.name" . }}-postgres \
                    -p {{ .Values.postgres.port }} \
                    -U {{ .Values.postgres.username }} \
                    -d {{ .Values.postgres.database }} \
                    --no-owner --no-acl \
                    | gzip > "${BACKUP_FILE}"

                  echo "Backup completed: ${BACKUP_FILE} ($(du -h "${BACKUP_FILE}" | cut -f1))"

                  # Retention: keep last 7 daily + 4 weekly (Sundays)
                  echo "Cleaning old backups..."
                  find /backups -name 'midst-*.sql.gz' -mtime +30 -delete
                  echo "Cleanup complete. Current backups:"
                  ls -lh /backups/
              env:
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "inmidst.fullname" . }}-secrets
                      key: postgres-password
              volumeMounts:
                - name: backup-storage
                  mountPath: /backups
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: {{ include "inmidst.name" . }}-pg-backups
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "inmidst.name" . }}-pg-backups
  labels:
    {{- include "inmidst.labels" . | nindent 4 }}
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.backup.storage | default "5Gi" }}
{{- end }}
